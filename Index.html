<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Book Appointment</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js"></script>
  <style>
    /* keep your existing styles (unchanged) */
  </style>
</head>
<body>
  <div class="container">
    <h3>Book Appointment</h3>

    <!-- Step 1: Enter ID -->
    <div class="form-group">
      <label for="idNumber">Enter ID Number:</label>
      <div class="fetch-section">
        <input id="idNumber" type="text" placeholder="Enter patient ID" />
        <button onclick="fetchPatient()">Fetch</button>
      </div>
      <div id="loader" style="display:none; text-align:center; margin-top:15px;">
        <div class="spinner"><div></div><div></div><div></div><div></div></div>
        <p style="margin-top:8px; font-size:14px; color:#00b894;">Fetching patient details...</p>
      </div>
    </div>

    <!-- Step 2: Patient details (auto-filled) -->
    <div id="patientDetails" style="display:none;">
      <div class="patient-info">
        <p>Name: <span id="name"></span></p>
        <p>Phone: <span id="phone"></span></p>
        <p>Age: <span id="age"></span></p>
        <p>Phase: <span id="phase"></span></p>
      </div>

      <div class="form-group">
        <label for="specialty">Specialty:</label>
        <select id="specialty">
          <option value="">-- Select --</option>
        </select>
        <div id="slotLoader" class="inline-spinner" style="display:none;"></div>
      </div>

      <div class="form-group">
        <label for="slot">Choose Time Slot:</label>
        <select id="slot">
          <option value="">Select specialty first</option>
        </select>
      </div>

      <div class="form-group">
        <label for="fileInput">Upload reports (optional):</label>
        <input id="fileInput" type="file" />
      </div>

      <div id="msg"></div>
      <button id="submitBtn">Confirm Booking</button>

      <div id="bookingSpinner" style="display:none; text-align:center; margin-top:15px;">
        <div class="inline-spinner"></div>
        <p style="margin-top:8px; font-size:15px; color:#0984e3;">Booking your appointment...</p>
      </div>
    </div>
  </div>

  <!-- Modal Popup -->
  <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999;">
    <div style="background:#fff; border-radius:16px; padding:40px 30px; max-width:350px; margin:120px auto; text-align:center; box-shadow:0 4px 24px rgba(0,0,0,0.15);">
      <h2 style="color:#00b894; margin-bottom:15px;">ðŸŽ‰ Appointment Booked!</h2>
      <p id="modalSlotLabel" style="font-size:17px; margin-bottom:22px;"></p>
      <button id="closeModalBtn" style="padding:10px 32px; border:none; background:#0984e3; color:#fff; font-size:16px; border-radius:10px; cursor:pointer;">OK</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection,
      query, where, getDocs, addDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // âœ… Your Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentPatient = null;

    async function fetchPatient() {
      const id = document.getElementById("idNumber").value.trim();
      if (!id) { alert("Enter ID"); return; }

      document.getElementById("loader").style.display = "block";

      const docRef = doc(db, "patients", id);
      const snap = await getDoc(docRef);
      document.getElementById("loader").style.display = "none";

      if (!snap.exists()) {
        alert("ID not found");
        return;
      }

      currentPatient = snap.data();
      currentPatient.idNumber = id;

      document.getElementById("name").textContent = currentPatient.name;
      document.getElementById("phone").textContent = currentPatient.phone;
      document.getElementById("age").textContent = currentPatient.age;
      document.getElementById("phase").textContent = currentPatient.phase;

      const sel = document.getElementById("specialty");
      sel.innerHTML = '<option value="">-- Select --</option>';
      (currentPatient.specialties || []).forEach(s =>
        sel.appendChild(new Option(s, s))
      );
      sel.onchange = onSpecialtyChange;

      document.getElementById("patientDetails").style.display = "block";
    }

    async function onSpecialtyChange() {
      const sp = document.getElementById("specialty").value;
      const slotSel = document.getElementById("slot");
      const slotLoader = document.getElementById("slotLoader");

      slotSel.innerHTML = "<option>Loading...</option>";
      slotLoader.style.display = "inline-block";

      if (!sp) {
        slotSel.innerHTML = "<option>Select specialty first</option>";
        slotLoader.style.display = "none";
        return;
      }

      const q = query(collection(db, "slots"), where("specialty", "==", sp), where("booked", "==", false));
      const snap = await getDocs(q);

      slotLoader.style.display = "none";
      slotSel.innerHTML = "";

      if (snap.empty) {
        slotSel.appendChild(new Option("No slots available", ""));
        return;
      }

      slotSel.appendChild(new Option("-- Select slot --", ""));
      snap.forEach(d => {
        const s = d.data();
        const val = JSON.stringify({ slotId: d.id, label: s.label });
        slotSel.appendChild(new Option(s.label, val));
      });
    }

    document.getElementById("submitBtn").addEventListener("click", async () => {
      if (!currentPatient) { alert("Fetch ID first"); return; }

      const sp = document.getElementById("specialty").value;
      const slotVal = document.getElementById("slot").value;
      if (!sp || !slotVal) { alert("Select specialty and slot"); return; }

      const slotObj = JSON.parse(slotVal);

      let fileUrl = "";
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const storageRef = ref(storage, "reports/" + Date.now() + "_" + file.name);
        await uploadBytes(storageRef, file);
        fileUrl = await getDownloadURL(storageRef);
      }

      document.getElementById("bookingSpinner").style.display = "block";
      document.getElementById("submitBtn").disabled = true;

      try {
        await addDoc(collection(db, "bookings"), {
          idNumber: currentPatient.idNumber,
          name: currentPatient.name,
          phone: currentPatient.phone,
          age: currentPatient.age,
          phase: currentPatient.phase,
          specialty: sp,
          slotId: slotObj.slotId,
          slotLabel: slotObj.label,
          fileUrl,
          status: "Pending",
          createdAt: new Date()
        });

        // mark slot as booked
        await updateDoc(doc(db, "slots", slotObj.slotId), { booked: true });

        document.getElementById("bookingSpinner").style.display = "none";
        document.getElementById("submitBtn").disabled = false;

        document.getElementById("modalSlotLabel").textContent = "Slot: " + slotObj.label;
        document.getElementById("modal").style.display = "block";
        document.getElementById("closeModalBtn").onclick = function() {
          document.getElementById("modal").style.display = "none";
          window.location.reload();
        };
      } catch (err) {
        alert("Failed: " + err.message);
        document.getElementById("bookingSpinner").style.display = "none";
        document.getElementById("submitBtn").disabled = false;
      }
    });

    window.fetchPatient = fetchPatient;
  </script>
</body>
</html>
